<!DOCTYPE html>
<html>
<head>
  <title>Edit Playlist</title>
</head>
<body>
  <h1>Edit Playlist: {{ name }}</h1>
  <form method="POST" action="{{ url_for('playlist_dashboard.edit_playlist', slug=slug) }}">
    <input type="hidden" name="form_origin" value="edit_playlist.html">
    <p><label>Playlist Name:<br>
      <input type="text" name="name" required value="{{ name }}">
    </label></p>

    <p><label>Match Type:<br>
      <select name="match">
        <option value="all" {% if match == "all" %}selected{% endif %}>All</option>
        <option value="any" {% if match == "any" %}selected{% endif %}>Any</option>
      </select>
    </label></p>

    <p><label>Limit:<br>
      <select name="limit">
        <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
        <option value="500" {% if limit == 500 %}selected{% endif %}>500</option>
        <option value="1000" {% if limit == 1000 %}selected{% endif %}>1000</option>
        <option value="9000" {% if limit == 9000 %}selected{% endif %}>9000</option>
      </select>
    </label></p>

    <h3>Conditions:</h3>
    <div id="rules-container">
      {% macro render_condition(cond) %}
        {% if cond.conditions is defined %}
          <div class="rule-group">
            <strong>Group ({{ cond.match | upper }}):</strong>
            <select name="group_match[]">
              <option value="all" {% if cond.match == "all" %}selected{% endif %}>All</option>
              <option value="any" {% if cond.match == "any" %}selected{% endif %}>Any</option>
            </select>
            {% for subcond in cond.conditions %}
              {{ render_condition(subcond) }}
            {% endfor %}
            <button type="button" onclick="addNestedRule(this)">âž• Add Rule</button>
          </div>
        {% else %}
          <div class="rule-row">
            <select name="field[]">
              <option value="artist" {% if cond.field == "artist" %}selected{% endif %}>Artist</option>
              <option value="track_name" {% if cond.field == "track_name" %}selected{% endif %}>Track Name</option>
              <option value="is_liked" {% if cond.field == "is_liked" %}selected{% endif %}>Is Liked</option>
              <option value="play_count" {% if cond.field == "play_count" %}selected{% endif %}>Play Count</option>
              <option value="last_played_at" {% if cond.field == "last_played_at" %}selected{% endif %}>Last Played</option>
              <option value="album_id" {% if cond.field == "album_id" %}selected{% endif %}>Album ID</option>
              <option value="disc_number" {% if cond.field == "disc_number" %}selected{% endif %}>Disc Number</option>
              <option value="track_number" {% if cond.field == "track_number" %}selected{% endif %}>Track Number</option>
              <option value="plays" {% if cond.field == "plays" %}selected{% endif %}>Plays</option>
            </select>

            <select name="operator[]">
              <option value="eq" {% if cond.operator == "eq" %}selected{% endif %}>=</option>
              <option value="neq" {% if cond.operator == "neq" %}selected{% endif %}>!=</option>
              <option value="gt" {% if cond.operator == "gt" %}selected{% endif %}>&gt;</option>
              <option value="lt" {% if cond.operator == "lt" %}selected{% endif %}>&lt;</option>
              <option value="contains" {% if cond.operator == "contains" %}selected{% endif %}>contains</option>
            </select>

            <input type="text" name="value[]" value="{{ cond.value }}">
            <button type="button" onclick="this.parentElement.remove()">âž–</button>
          </div>
        {% endif %}
      {% endmacro %}
      {% for cond in conditions %}
        {{ render_condition(cond) }}
      {% endfor %}
    </div>

    <div class="rule-row">
      <select name="field[]">
        <option value="artist">Artist</option>
        <option value="track_name">Track Name</option>
        <option value="is_liked">Is Liked</option>
        <option value="play_count">Play Count</option>
        <option value="last_played_at">Last Played</option>
        <option value="album_id">Album ID</option>
        <option value="disc_number">Disc Number</option>
        <option value="track_number">Track Number</option>
        <option value="plays">Plays</option>
      </select>

      <select name="operator[]">
        <option value="eq">=</option>
        <option value="neq">!=</option>
        <option value="gt">&gt;</option>
        <option value="lt">&lt;</option>
        <option value="contains">contains</option>
      </select>

      <input type="text" name="value[]" placeholder="Enter value">
      <button type="button" onclick="this.parentElement.remove()">âž–</button>
    </div>
    <button type="button" onclick="addRule()">âž• Add Rule</button>
    <button type="button" onclick="addGroupRule()">âž• Add Nested Group</button>

    <h3>Sort By:</h3>
    {% set sort = sort_rules %}
    <div id="sort-container">
      {% if sort %}
        {% for s in sort %}
          <div class="sort-row">
            <select name="sort_by[]">
              <option value="artist" {{ 'selected' if s.by == 'artist' }}>Artist</option>
              <option value="track_name" {{ 'selected' if s.by == 'track_name' }}>Track Name</option>
              <option value="is_liked" {{ 'selected' if s.by == 'is_liked' }}>Is Liked</option>
              <option value="play_count" {{ 'selected' if s.by == 'play_count' }}>Play Count</option>
              <option value="last_played_at" {{ 'selected' if s.by == 'last_played_at' }}>Last Played</option>
              <option value="album_id" {{ 'selected' if s.by == 'album_id' }}>Album ID</option>
              <option value="disc_number" {{ 'selected' if s.by == 'disc_number' }}>Disc Number</option>
              <option value="track_number" {{ 'selected' if s.by == 'track_number' }}>Track Number</option>
              <option value="plays" {{ 'selected' if s.by == 'plays' }}>Plays</option>
            </select>
            <select name="sort_direction[]">
              <option value="asc" {% if s.direction == "asc" %}selected{% endif %}>Ascending</option>
              <option value="desc" {% if s.direction == "desc" %}selected{% endif %}>Descending</option>
            </select>
            <button type="button" onclick="this.parentElement.remove()">âž–</button>
          </div>
        {% endfor %}
      {% else %}
        <div class="sort-row">
          <select name="sort_by[]">
            <option value="artist">Artist</option>
            <option value="track_name">Track Name</option>
            <option value="is_liked">Is Liked</option>
            <option value="play_count">Play Count</option>
            <option value="last_played_at">Last Played</option>
            <option value="album_id">Album ID</option>
            <option value="disc_number">Disc Number</option>
            <option value="track_number">Track Number</option>
            <option value="plays">Plays</option>
          </select>
          <select name="sort_direction[]">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
          </select>
          <button type="button" onclick="this.parentElement.remove()">âž–</button>
        </div>
      {% endif %}
    </div>
    <button type="button" onclick="addSortRule()">âž• Add Sort Rule</button>

    <br>
    <button type="submit">ðŸ’¾ Save Changes</button>
    <a href="/dashboard/playlists"><button type="button">ðŸ”™ Back</button></a>
  </form>
  <!-- End of form and body content -->
</body>
<script>
  document.querySelector('form').addEventListener('submit', function (e) {
    const sortFields = [...document.querySelectorAll('select[name="sort_by[]"]')];
    const sortDirections = [...document.querySelectorAll('select[name="sort_direction[]"]')];

    console.log('Submitting sort_by:', sortFields.map(s => s.value));
    console.log('Submitting sort_direction:', sortDirections.map(s => s.value));
  });
</script>
<script>
  function addRule() {
    const container = document.getElementById('rules-container');
    const newRow = document.createElement('div');
    newRow.className = 'rule-row';
    newRow.innerHTML = `
      <select name="field[]">
        <option value="artist">Artist</option>
        <option value="track_name">Track Name</option>
        <option value="is_liked">Is Liked</option>
        <option value="play_count">Play Count</option>
        <option value="last_played_at">Last Played</option>
        <option value="album_id">Album ID</option>
        <option value="disc_number">Disc Number</option>
        <option value="track_number">Track Number</option>
        <option value="plays">Plays</option>
      </select>
      <select name="operator[]">
        <option value="eq">=</option>
        <option value="neq">!=</option>
        <option value="gt">&gt;</option>
        <option value="lt">&lt;</option>
        <option value="contains">contains</option>
      </select>
      <input type="text" name="value[]" placeholder="Enter value">
      <button type="button" onclick="this.parentElement.remove()">âž–</button>
    `;
    container.appendChild(newRow);
  }
</script>
<script>
  function addSortRule() {
    const container = document.getElementById('sort-container');
    const newRow = document.createElement('div');
    newRow.className = 'sort-row';
    newRow.innerHTML = `
      <select name="sort_by[]">
        <option value="artist">Artist</option>
        <option value="track_name">Track Name</option>
        <option value="is_liked">Is Liked</option>
        <option value="play_count">Play Count</option>
        <option value="last_played_at">Last Played</option>
        <option value="album_id">Album ID</option>
        <option value="disc_number">Disc Number</option>
        <option value="track_number">Track Number</option>
        <option value="plays">Plays</option>
      </select>
      <select name="sort_direction[]">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
      </select>
      <button type="button" onclick="this.parentElement.remove()">âž–</button>
    `;
    container.appendChild(newRow);
  }
</script>
<script>
  function addNestedRule(button) {
    const groupContainer = button.parentElement;
    const newRow = document.createElement('div');
    newRow.className = 'rule-row';
    newRow.innerHTML = `
      <select name="field[]">
        <option value="artist">Artist</option>
        <option value="track_name">Track Name</option>
        <option value="is_liked">Is Liked</option>
        <option value="play_count">Play Count</option>
        <option value="last_played_at">Last Played</option>
        <option value="album_id">Album ID</option>
        <option value="disc_number">Disc Number</option>
        <option value="track_number">Track Number</option>
        <option value="plays">Plays</option>
      </select>
      <select name="operator[]">
        <option value="eq">=</option>
        <option value="neq">!=</option>
        <option value="gt">&gt;</option>
        <option value="lt">&lt;</option>
        <option value="contains">contains</option>
      </select>
      <input type="text" name="value[]" placeholder="Enter value">
      <button type="button" onclick="this.parentElement.remove()">âž–</button>
    `;
    groupContainer.insertBefore(newRow, button);
  }
</script>
<script>
  function addGroupRule() {
    const container = document.getElementById('rules-container');
    const groupDiv = document.createElement('div');
    groupDiv.className = 'rule-group';
    groupDiv.innerHTML = `
      <strong>Group (ANY):</strong>
      <select name="group_match[]">
        <option value="all">All</option>
        <option value="any" selected>Any</option>
      </select>
      <div class="rule-row">
        <select name="field[]">
          <option value="artist">Artist</option>
          <option value="track_name">Track Name</option>
          <option value="is_liked">Is Liked</option>
          <option value="play_count">Play Count</option>
          <option value="last_played_at">Last Played</option>
          <option value="album_id">Album ID</option>
          <option value="disc_number">Disc Number</option>
          <option value="track_number">Track Number</option>
          <option value="plays">Plays</option>
        </select>
        <select name="operator[]">
          <option value="eq">=</option>
          <option value="neq">!=</option>
          <option value="gt">&gt;</option>
          <option value="lt">&lt;</option>
          <option value="contains">contains</option>
        </select>
        <input type="text" name="value[]" placeholder="Enter value">
        <button type="button" onclick="this.parentElement.remove()">âž–</button>
      </div>
      <button type="button" onclick="addNestedRule(this)">âž• Add Rule</button>
    `;
    container.appendChild(groupDiv);
  }
</script>
</html>