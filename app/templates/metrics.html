<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Listening Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .charts-grid {
      display: flex;
      flex-direction: column;
      gap: 3rem;
      margin: 2rem auto;
      max-width: 900px;
    }
    .chart-card {
      background: #ffffff;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      min-height: 400px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
    .summary-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin: 2rem auto 1rem;
      max-width: 900px;
    }
    .summary-cards .card {
      flex: 1 1 200px;
      text-align: center;
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 10px;
      font-weight: 600;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }
    .summary-cards .card span {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>📊 Your Listening Stats</h1>
    <p>A fun look at your Spotify data — like your own Wrapped!</p>
    <div style="margin-top:1rem;">
      <a href="/" style="color:#1DB954;font-weight:600;">← Back to Home</a>
    </div>
  </header>

  <main>
    <div class="summary-cards">
      <div class="card" id="summary-artists">🎤 Artists<br><span>...</span></div>
      <div class="card" id="summary-tracks">🎵 Tracks<br><span>...</span></div>
      <div class="card" id="summary-liked">❤️ Liked Songs<br><span>...</span></div>
      <div class="card" id="summary-plays">▶️ Total Plays<br><span>...</span></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <section id="top-artists">
          <h2>🎤 Top Artists</h2>
          <canvas id="chart-top-artists" height="200"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="top-tracks">
          <h2>🎵 Most Played Tracks</h2>
          <canvas id="chart-top-tracks" height="200"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="top-albums">
          <h2>💿 Top Albums</h2>
          <canvas id="chart-top-albums" height="200"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="listens-over-time">
          <h2>📈 Listening Over Time</h2>
          <canvas id="chart-listens-over-time" style="height:300px;"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="plays-by-day">
          <h2>📅 Listening by Day of Week</h2>
          <canvas id="chart-plays-by-day"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="plays-by-hour">
          <h2>🕓 Listening by Hour of Day</h2>
          <canvas id="chart-plays-by-hour"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="plays-by-month">
          <h2>🗓️ Listening by Month</h2>
          <canvas id="chart-plays-by-month"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="added-tracks-over-time">
          <h2>➕ Tracks Added Over Time</h2>
          <canvas id="chart-added-tracks"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="top-liked-artists">
          <h2>❤️ Top Liked Artists</h2>
          <canvas id="chart-top-liked-artists"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="unplayable-tracks">
          <h2>🚫 Unavailable Tracks Over Time</h2>
          <canvas id="chart-unavailable-tracks"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="release-to-play-distribution">
          <h2>⏱️ Time to First Play</h2>
          <canvas id="chart-release-to-play"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="monthly-library-growth">
          <h2>📚 Monthly Library Growth</h2>
          <canvas id="chart-library-growth"></canvas>
        </section>
      </div>
      <div class="chart-card">
        <section id="top-artist-monthly">
          <h2>🏆 Top Artist Each Month</h2>
          <canvas id="chart-top-artist-monthly"></canvas>
        </section>
      </div>
    </div>
  </main>

  <script>
    async function loadMetrics() {
      const res = await fetch('/metrics-data');
      const data = await res.json();
      document.getElementById('summary-artists').querySelector('span').textContent = data.summary.total_artists;
      document.getElementById('summary-tracks').querySelector('span').textContent = data.summary.total_tracks;
      document.getElementById('summary-liked').querySelector('span').textContent = data.summary.total_liked;
      document.getElementById('summary-plays').querySelector('span').textContent = data.summary.total_plays;

      // Top Artists
      const artistNames = data.top_artists.map(a => a.artist);
      const artistPlays = data.top_artists.map(a => a.count);
      new Chart(document.getElementById('chart-top-artists'), {
        type: 'bar',
        data: {
          labels: artistNames,
          datasets: [{ label: 'Plays', data: artistPlays }]
        }
      });

      // Top Tracks
      const trackNames = data.top_tracks.map(t => t.track);
      const trackPlays = data.top_tracks.map(t => t.count);
      new Chart(document.getElementById('chart-top-tracks'), {
        type: 'bar',
        data: {
          labels: trackNames,
          datasets: [{ label: 'Plays', data: trackPlays }]
        }
      });

      // Top Albums
      const albumNames = data.top_albums.map(a => a.album);
      const albumPlays = data.top_albums.map(a => a.count);
      new Chart(document.getElementById('chart-top-albums'), {
        type: 'bar',
        data: {
          labels: albumNames,
          datasets: [{ label: 'Plays', data: albumPlays }]
        }
      });

      // Listens Over Time
      const dates = data.daily_plays.map(p => p.date);
      const counts = data.daily_plays.map(p => Number(p.count));
      const listensCanvas = document.getElementById('chart-listens-over-time');
      if (listensCanvas) {
        const ctxListens = listensCanvas.getContext('2d');
        new Chart(ctxListens, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Listens',
              data: counts,
              fill: false,
              borderColor: '#1DB954',
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      // Listening by Day of Week
      const dayLabels = data.plays_by_day.map(p => p.day.trim());
      const dayCounts = data.plays_by_day.map(p => Number(p.count));
      new Chart(document.getElementById('chart-plays-by-day'), {
        type: 'bar',
        data: {
          labels: dayLabels,
          datasets: [{ label: 'Plays', data: dayCounts }]
        }
      });

      // Listening by Hour of Day
      const hourLabels = data.plays_by_hour.map(p => `${p.hour}:00`);
      const hourCounts = data.plays_by_hour.map(p => Number(p.count));
      new Chart(document.getElementById('chart-plays-by-hour'), {
        type: 'bar',
        data: {
          labels: hourLabels,
          datasets: [{ label: 'Plays', data: hourCounts }]
        }
      });

      // Listening by Month
      const monthLabels = data.plays_by_month.map(p => p.month);
      const monthCounts = data.plays_by_month.map(p => Number(p.count));
      new Chart(document.getElementById('chart-plays-by-month'), {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{ label: 'Plays', data: monthCounts }]
        }
      });

      // Tracks Added Over Time
      const addedDates = data.tracks_added.map(p => p.date);
      const addedCounts = data.tracks_added.map(p => Number(p.count));
      new Chart(document.getElementById('chart-added-tracks'), {
        type: 'line',
        data: {
          labels: addedDates,
          datasets: [{ label: 'Tracks Added', data: addedCounts }]
        }
      });

      // Top Liked Artists
      const likedArtists = data.top_liked_artists.map(p => p.artist);
      const likedCounts = data.top_liked_artists.map(p => Number(p.count));
      new Chart(document.getElementById('chart-top-liked-artists'), {
        type: 'bar',
        data: {
          labels: likedArtists,
          datasets: [{ label: 'Liked Songs', data: likedCounts }]
        }
      });

      // Unavailable Tracks Over Time
      const unavailableDates = data.unplayable_tracks.map(p => p.date);
      const unavailableCounts = data.unplayable_tracks.map(p => Number(p.count));
      new Chart(document.getElementById('chart-unavailable-tracks'), {
        type: 'line',
        data: {
          labels: unavailableDates,
          datasets: [{
            label: 'Unavailable Tracks',
            data: unavailableCounts,
            fill: false,
            borderColor: '#ff0000'
          }]
        }
      });

      // Time to First Play from Release
      const rtpLabels = data.release_to_play.map(p => p.bucket);
      const rtpCounts = data.release_to_play.map(p => Number(p.count));
      new Chart(document.getElementById('chart-release-to-play'), {
        type: 'bar',
        data: {
          labels: rtpLabels,
          datasets: [{ label: 'Tracks', data: rtpCounts }]
        }
      });

      // Monthly Library Growth
      const growthLabels = data.library_growth.map(p => p.month);
      const growthCounts = data.library_growth.map(p => Number(p.added));
      new Chart(document.getElementById('chart-library-growth'), {
        type: 'line',
        data: {
          labels: growthLabels,
          datasets: [{
            label: 'Tracks Added',
            data: growthCounts,
            borderColor: '#0074D9',
            fill: false
          }]
        }
      });

      // Top Artist by Month
      const topArtistMonthLabels = data.top_artist_by_month.map(p => p.month);
      const topArtistNames = data.top_artist_by_month.map(p => p.artist);
      const topArtistPlays = data.top_artist_by_month.map(p => Number(p.plays));
      new Chart(document.getElementById('chart-top-artist-monthly'), {
        type: 'bar',
        data: {
          labels: topArtistMonthLabels.map((m, i) => `${m} (${topArtistNames[i]})`),
          datasets: [{ label: 'Plays', data: topArtistPlays }]
        }
      });
    }

    loadMetrics();
  </script>
</body>
</html>