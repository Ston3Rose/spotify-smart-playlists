<h2>‚ûï Create New Smart Playlist</h2>
<form method="post" onsubmit="console.log('Submitting form with serialized rules:', document.getElementById('rules_json').value); return serializeRules()">
  <label>
    Playlist Name:
    <input type="text" name="name" required>
  </label>
  <br><br>


  <label>
    Track Limit:
    <select name="limit" required>
      <option value="50" selected>50</option>
      <option value="100">100</option>
      <option value="500">500</option>
      <option value="1000">1000</option>
      <option value="9000">9000</option>
      <option value="no_limit">No Limit</option>
    </select>
  </label>

  <br><br>
  <label>
    Sort By:
    <div id="sort-container">
      <div class="sort-row">
        <select name="sort_by[]">
          <option value="album_id" selected>Album ID</option>
          <option value="artist">Artist</option>
          <option value="track">Track</option>
          <option value="added_at">Date Added</option>
          <option value="play_count">Number of Plays</option>
          <option value="last_played_at">Last Played</option>
          <option value="first_played_at">First Played</option>
          <option value="disc_number">Disc Number</option>
          <option value="track_number">Track Number</option>
        </select>
        <select name="sort_direction[]">
          <option value="asc" selected>Ascending</option>
          <option value="desc">Descending</option>
        </select>
        <button type="button" onclick="removeSort(this)">‚àí</button>
      </div>
    </div>
    <button type="button" onclick="addSort()">‚ûï Add Sort Rule</button>
  </label>

  <hr>
  <h3>Filter Rules</h3>
  <label>
    Match 
    <select name="match" id="match" required>
      <option value="all">all</option>
      <option value="any">any</option>
    </select>
    of the following rules:
  </label>

  <div id="rules-container">
    <div class="rule-row">
      <select name="field[]">
        <option value="artist">Artist</option>
        <option value="album">Album</option>
        <option value="track">Track</option>
        <option value="is_liked">Is Liked</option>
        <option value="date_added">Date Added</option>
        <option value="plays">Number of Plays</option>
        <option value="last_played">Last Played</option>
        <option value="first_played">First Played</option>
      </select>

      <select name="operator[]">
        <option value="is">is</option>
        <option value="is_not">is not</option>
        <option value="contains">contains</option>
        <option value="not_contains">does not contain</option>
        <option value="gt">greater than</option>
        <option value="lt">less than</option>
      </select>

      <input type="text" name="value[]">
      <button type="button" onclick="removeRule(this)">‚àí</button>
    </div>
  </div>

  <button type="button" onclick="addRule()">‚ûï Add Rule</button>

  <script>
    function addRule() {
      const container = document.getElementById('rules-container');
      const rule = container.querySelector('.rule-row').cloneNode(true);
      rule.querySelectorAll('input').forEach(input => input.value = '');
      container.appendChild(rule);
    }

    function removeRule(button) {
      const container = document.getElementById('rules-container');
      if (container.children.length > 1) {
        button.parentElement.remove();
      }
    }

    function addSort() {
      const container = document.getElementById('sort-container');
      const sortRow = container.querySelector('.sort-row').cloneNode(true);
      container.appendChild(sortRow);
    }

    function removeSort(button) {
      const container = document.getElementById('sort-container');
      if (container.children.length > 1) {
        button.parentElement.remove();
      }
    }

    function serializeRules() {
      const rules = {
        match: document.getElementById("match").value,
        limit: document.querySelector('[name="limit"]').value === 'no_limit' ? 9000 : parseInt(document.querySelector('[name="limit"]').value),
        sort: Array.from(document.querySelectorAll('#sort-container .sort-row')).map(row => ({
          by: row.querySelector('[name="sort_by[]"]').value,
          direction: row.querySelector('[name="sort_direction[]"]').value
        })),
        conditions: []
      };

      const rows = document.querySelectorAll(".rule-row");
      rows.forEach(row => {
        const field = row.querySelector('[name="field[]"]').value;
        const operator = row.querySelector('[name="operator[]"]').value;
        const value = row.querySelector('[name="value[]"]').value;
        if (field && operator && value) {
          rules.conditions.push({ field, operator, value });
        }
      });

      document.getElementById("rules_json").value = JSON.stringify(rules);
      return true;
    }
  </script>

  <input type="hidden" name="rules_json" id="rules_json">
  <button type="submit">üé∂ Create Playlist</button>
</form>

<p><a href="/dashboard/playlists">‚¨ÖÔ∏è Back to Playlists</a></p>